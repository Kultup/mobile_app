# Технічне завдання (ТЗ)  
## 1. Загальний опис проекту

Мета проекту — створення корпоративного мобільного додатку (iOS + Android) та веб-адміністративної панелі для щоденного навчання та підвищення кваліфікації персоналу ресторанів мережі (офіціанти, банкетні менеджери, кухарі, адміністратори).

Додаток працює у форматі щоденних міні-тестів (5 питань на день) з автоматичною розсилкою, миттєвим зворотним зв'язком та гейміфікацією (рейтинг, статистика). Також передбачена довідкова база знань та форми зворотного зв'язку.

## 2. Цільова аудиторія

- Працівники ресторанів мережі «Країна Мрій» (офіціанти, кухарі, банкетні менеджери, адміністратори тощо)

- Адміністратори/навчальні менеджери мережі (користувачі адмін-панелі)

## 3. Платформи

- Мобільний додаток: iOS 14+ та Android 8+

- Адміністративна панель: веб (десктоп + планшет, адаптивний дизайн)

## 4. Функціонал мобільного додатку

### 4.1. Авторизація та реєстрація

- Реєстрація/вхід за ПІБ, містом та посадою

- Посади та міста завантажуються зі списку (довідник з адмінки)

- Заборона дублювання користувачів за ПІБ + місто + посада

- Після реєстрації перший щоденний тест приходить лише наступного дня

### 4.2. Щоденне тестування

- Кожного дня користувачу стає доступним новий тест з 5 питаннями

- Тест стає доступним о 00:00 поточного дня (час може налаштовуватися в адмінці)

- Користувач отримує push-повідомлення про новий тест (час розсилки налаштовується в адмінці, за замовчуванням 12:00)

- Питання випадково обираються по 1–2 з різних категорій (щоб уникнути повторів у межах одного тесту)

- Дедлайн проходження — 23:59 поточного дня

- Якщо користувач не відкрив тест або не завершив до 00:00 — тест не зараховується, бали не нараховуються

- Нагадування push-повідомленням за 3 години та за 1 годину до дедлайну (якщо тест не розпочато/не завершено)

### 4.3. Проходження тесту

- Тести доступні щодня (кожного дня), без прив'язки до графіку

- Питання відображаються по одному

- Типи питань:

  - Один правильний варіант з 4 варіантів відповіді

- Медіа до питання:

  - Фото до питання (відображається над текстом питання)

  - Відео до питання (відеоплеєр з можливістю паузи/відтворення)

  - Підтримка різних форматів медіа

- Після вибору відповіді:

  - Якщо правильно — +1 бал, автоматичний перехід до наступного питання

  - Якщо неправильно — підсвічується правильна відповідь + коротке пояснення + кнопка «Докладніше» (перехід у відповідний розділ бази знань)

- Після останнього питання — екран з результатом дня (скільки правильних з 5, набрані бали, зміна позиції в рейтингу)

### 4.4. База знань (довідник)

- Категорії та підкатегорії (дерево)

- Пошук по тексту

- Статті з текстом, фото, PDF-файлами

- З питань тесту передбачена кнопка «Докладніше» → пряме посилання на відповідну статтю

### 4.5. Рейтинг та статистика користувача

- Глобальний рейтинг мережі (топ-100 або всі)

- Рейтинг за містом та за посадою (окремі вкладки)

- Особиста статистика:

  - Кількість пройдених тестів

  - % правильних відповідей за весь час та за останній місяць

  - Серія днів поспіль (streak)

  - Графік прогресу

### 4.5.1. Гейміфікація та ачівки

- Система ачівок (досягнень) для мотивації користувачів

- Категорії ачівок:

  - Тестування: пройдено X тестів (10, 50, 100, 500)

  - Активність: streak X днів (7, 30, 100 днів)

  - Точність: X тестів поспіль на 5/5, 100% правильних за місяць

  - Рейтинг: потрапити в топ-100, топ-10, перше місце

  - Спеціальні: ювілейні дати, особливі події

- Відображення прогресу до кожної ачівки

- Анімація та сповіщення при отриманні ачівки

- Нарахування додаткових балів за отримання ачівок

- Push-повідомлення про отримані ачівки

### 4.5.2. Система балів та внутрішній магазин

- Нарахування балів:

  - +1 бал за кожну правильну відповідь

  - Бонуси за streak (додаткові бали за серію днів)

  - Бонуси за отримання ачівок

- Відображення балансу балів користувача

- Внутрішній магазин для витрати балів:

  - Аватарки/профільні фото (різні стилі)

  - Рамки для профілю

  - Бейджі/значки для профілю

  - Темна тема (premium)

  - Кастомізація інтерфейсу

  - Додаткові статистики

  - Подарунки для колег (опційно)

- Покупка товарів за бали

- Застосування куплених товарів (аватарки, рамки, теми)

- Історія покупок та нарахування балів

### 4.6. Зворотний зв'язок

- Окремий розділ «Опитування та пропозиції»

- Можливість оцінити оновлення меню, якість навчання (1–5 зірок + коментар)

- Форма «Запропонувати питання» або «Повідомити про помилку в питанні»

### 4.7. Push-повідомлення

- Щоденний тест о 12:00

- Нагадування за 3 та 1 годину

- Системні сповіщення (нове опитування, відповідь адміністратора тощо)

## 5. Адміністративна веб-панель

**Адмін-панель є центральною точкою управління всім контентом та функціоналом мобільного додатку.**

Через адмін-панель адміністратор має повний контроль над усім контентом, який відображається користувачам у мобільному додатку.

### 5.1. Автентифікація

- Вхід за логіном/паролем (ролі: супер-адмін, адміністратор навчання, перегляд тільки статистики)

### 5.2. Управління контентом мобільного додатку

**Всі зміни, зроблені в адмін-панелі, одразу відображаються в мобільному додатку для всіх користувачів.**

#### 5.2.1. Управління питаннями для тестів

- Категорії питань (дерево, сортування)

- Питання:

  - Текст питання та варіанти відповідей

  - Вказівка правильних відповідей

  - Категорія

  - Пояснення при неправильній відповіді (текст + посилання на статтю бази знань)

  - Медіа до питання (опційно):
    - Фото до питання
    - Відео до питання
    - Підтримка різних форматів (JPG, PNG для фото; MP4, MOV для відео)

  - Активність питання (увімк/вимк)

  - Масове імпортування з Excel

#### 5.2.2. Управління базою знань

- Категорії (дерево)

- Статті (Markdown-редактор або WYSIWYG, підтримка зображень та PDF)

- Пошук та сортування

#### 5.2.3. Управління ачівками

- Створення нових ачівок

- Налаштування умов отримання (кількість тестів, streak, точність, рейтинг)

- Налаштування нагороди (бали)

- Завантаження іконок для ачівок

- Категорії ачівок

- Статистика отримання ачівок користувачами

#### 5.2.4. Управління внутрішнім магазином

- Створення товарів (аватарки, рамки, бейджі, теми)

- Налаштування цін (в балах)

- Завантаження зображень товарів

- Категорії товарів

- Статистика покупок

- Управління доступністю товарів

### 5.3. Управління користувачами

- Список всіх працівників

- Фільтри за містом, посадою, активністю

- Видалення/блокування користувачів (звільнені)

- Ручне редагування ПІБ, посади, міста

### 5.4. Статистика та звіти

- Таблиця результатів по днях та користувачах

- Рейтинги (загальний, за містом, за посадою)

- % проходження тестів за період

- Теплова карта активності по містах та посадах

- Експорт будь-яких таблиць у Excel/CSV

- Графіки та дашборди

### 5.5. Налаштування системи

- Час щоденної розсилки (за замовчуванням 12:00)

- Час дедлайну (за замовчуванням 23:59)

- Час нагадувань

- Текст системних push-повідомлень

- Список міст та посад (довідники)

### 5.6. Опитування та зворотний зв'язок

- Створення нових опитувань (1–5 зірок, кілька варіантів, відкрите питання)

- Перегляд відповідей та експорт

- Перегляд пропозицій питань від користувачів

- Перегляд звітів про помилки в питаннях

## 6. Статус реалізації

### ✅ Реалізовано (Skeleton):

**Backend:**
- ✅ Структура проекту NestJS
- ✅ Всі модулі створені (auth, users, questions, tests, knowledge-base, ratings, surveys, achievements, shop, admin, push, files, cron)
- ✅ MongoDB схеми для основних сутностей:
  - ✅ User (користувачі)
  - ✅ AdminUser (адміністратори)
  - ✅ Question (питання з підтримкою фото/відео)
  - ✅ QuestionCategory (категорії питань)
  - ✅ UserTest (проходження тестів)
  - ✅ Achievement (ачівки)
  - ✅ UserAchievement (отримані ачівки)
  - ✅ ShopProduct (товари магазину)
  - ✅ UserPurchase (покупки)
  - ✅ PointsTransaction (транзакції балів)
  - ✅ KnowledgeBaseArticle (статті бази знань)
  - ✅ KnowledgeBaseCategory (категорії бази знань)
  - ✅ Survey (опитування)
  - ✅ SurveyResponse (відповіді на опитування)
  - ✅ PushToken (токени для push-повідомлень)
  - ✅ City (міста)
  - ✅ Position (посади)
  - ✅ SystemSettings (налаштування системи)
  - ✅ AdminActivityLog (лог дій адміністраторів)
  - ✅ FeedbackQuestion (пропозиції питань)
  - ✅ FeedbackErrorReport (звіти про помилки)
- ✅ Guards та декоратори (JWT, Roles, Public)
- ✅ Аутентифікація (JWT стратегія)
- ✅ Логування (Winston)
- ✅ Cron jobs для щоденних завдань
- ✅ Фільтри та інтерцептори
- ✅ DTOs для валідації:
  - ✅ CreateQuestionDto, UpdateQuestionDto
  - ✅ CreateAchievementDto
  - ✅ CreateShopProductDto, PurchaseProductDto, ApplyProductDto
  - ✅ CreateKnowledgeArticleDto
  - ✅ UpdateProfileDto
  - ✅ SubmitAnswerDto
  - ✅ SurveyResponseDto
  - ✅ PaginationDto
- ✅ Реалізована логіка в сервісах:
  - ✅ QuestionsService (CRUD з пагінацією та пошуком)
  - ✅ UsersService (профіль, статистика, баланс)
  - ✅ ShopService (товари, покупки, застосування)
  - ✅ KnowledgeBaseService (статті з переглядами)
  - ✅ AchievementsService (отримані та всі ачівки)
  - ✅ RatingsService (глобальний, за містом, за посадою)
  - ✅ SurveysService (опитування та відповіді)
  - ✅ AdminService (дашборд з метриками)
  - ✅ TestsService (щоденні тести, відповіді, завершення, оновлення статистики)
  - ✅ PushService (реєстрація токенів, відправка повідомлень)
  - ✅ FilesService (завантаження фото/відео)
  - ✅ AuthService (реєстрація, логін, профіль)
  - ✅ CronService (генерація щоденних тестів о 00:00, push-нагадування о 12:00, 21:00, 23:00)
  - ✅ AchievementsCheckerService (автоматична перевірка та нарахування ачівок після тестів)
  - ✅ FeedbackService (пропозиції питань, звіти про помилки)
- ✅ AdminService (CRUD для користувачів та адмінів)
- ✅ CitiesController, PositionsController (CRUD для міст та посад)

**Frontend:**
- ✅ Структура проекту React + TypeScript + Vite
- ✅ Routing з React Router
- ✅ Layout компоненти (Sidebar, Header)
- ✅ API сервіси (admin, questions, cities, positions, auth, knowledge-base, surveys, achievements, shop)
- ✅ Material-UI тема з кольорами з ТЗ
- ✅ API сервіс з axios та interceptors
- ✅ Auth hook з логіном та логаутом
- ✅ React Query для state management
- ✅ Реалізовані сторінки:
  - ✅ Dashboard (дашборд з реальними даними)
  - ✅ Questions (таблиця питань, пошук, фільтри, CRUD)
  - ✅ QuestionFormPage (форма створення/редагування питань з валідацією)
  - ✅ Users (таблиця користувачів, пошук, фільтри за містом/посадою/статусом)
  - ✅ Login (форма авторизації)
- ✅ Реалізовані сторінки:
  - ✅ Knowledge Base (таблиця статей, пошук, CRUD)
  - ✅ Statistics (графіки та статистика)
  - ✅ Surveys (таблиця опитувань, фільтри, CRUD)
  - ✅ Achievements (таблиця ачівок, фільтри за категорією, CRUD)
  - ✅ Shop (таблиця товарів, фільтри за типом, CRUD)
  - ✅ Settings (налаштування системи - форма)

**Документація:**
- ✅ ТЗ дизайну мобільного додатку
- ✅ Плани розробки (Backend, Frontend, Mobile)
- ✅ Інструкція з встановлення

### ⏳ Потрібно реалізувати:

**Backend:**
- [x] Логіка в сервісах (реалізовано: questions, users, shop, knowledge-base, achievements, ratings, surveys, admin, tests, push, files, auth)
- [x] Повна реалізація аутентифікації (register, login, admin login, refresh token, profile)
- [x] Реалізація CRUD операцій (questions, users, shop, knowledge-base)
- [x] Реалізація тестів (getDailyTest, startTest, submitAnswer, completeTest, history)
- [x] Завантаження файлів (фото/відео з валідацією)
- [x] Push-повідомлення (реєстрація токенів, базова структура відправки)
- [x] Генерація щоденних тестів (cron о 00:00)
- [x] Розсилка нагадувань (12:00, 21:00, 23:00)
- [x] Оновлення статистики після завершення тесту (бали, streak, транзакції)
- [x] Система ачівок (автоматична перевірка після тестів, нарахування бонусних балів)
- [x] Система балів та магазин (повністю реалізовано)
- [x] FeedbackService (пропозиції питань, звіти про помилки)
- [x] AdminService (CRUD для користувачів та адміністраторів)
- [x] CitiesController, PositionsController (CRUD для міст та посад)
- [ ] Push-повідомлення (Firebase FCM інтеграція - залишилось підключити SDK)
- [ ] Тести (unit, integration, e2e)
- [ ] Swagger документація

**Frontend:**
- [x] Реалізація форм (React Hook Form + Yup валідація)
- [x] Таблиці та списки з пагінацією (Questions, Users)
- [x] Інтеграція з API (admin, questions, cities, positions)
- [x] Обробка помилок (interceptors, Alert компоненти)
- [x] Loading states (CircularProgress)
- [x] Валідація форм (Yup схеми)
- [x] Завантаження файлів (для питань з медіа - компонент FileUpload з прев'ю)
- [x] Графіки та діаграми (Statistics page - Recharts)
- [x] Реалізація інших сторінок (Knowledge Base, Surveys, Achievements, Shop, Statistics, Settings)

**Mobile:**
- [ ] Створення React Native проекту
- [ ] Реалізація екранів
- [ ] Інтеграція з API
- [ ] Push-повідомлення
- [ ] Офлайн-режим

## 6. Технічні вимоги

### 6.1. Мобільний додаток

- React Native (або Flutter) для кросплатформовості

- Offline-режим для бази знань (кешування статей та фото)

- Push-повідомлення (див. розділ 6.1.1)

- Бекенд — Node.js / NestJS (рекомендовано для MongoDB) або Express.js

#### 6.1.1. Push-сервіси для повідомлень

**Рекомендовані варіанти:**

**1. Firebase Cloud Messaging (FCM) - Рекомендовано для старту**
- ✅ Повністю безкоштовний
- ✅ Підтримка iOS, Android, Web
- ✅ Надійна інфраструктура Google
- ✅ Детальна аналітика
- ✅ Rich notifications (зображення, кнопки)
- ✅ Topic-based messaging
- ❌ Прив'язка до екосистеми Google
- **Ціна:** Безкоштовно

**2. OneSignal - Альтернатива**
- ✅ Безкоштовний план до 10,000 підписників
- ✅ Проста інтеграція
- ✅ Підтримка iOS, Android, Web, Email, SMS
- ✅ Сегментація аудиторії
- ✅ A/B тестування
- ✅ Автоматизація (triggers)
- ✅ Детальна аналітика
- ❌ Обмеження на безкоштовному плані
- **Ціна:** Free до 10K, від $9/міс

**3. Інші альтернативи:**
- **Pusher Beams** — безкоштовно до 2K користувачів, від $49/міс
- **Pushwoosh** — trial 14 днів, від $49/міс (потужна платформа)
- **Airship** — enterprise рішення, від $500+/міс
- **CleverTap** — фокус на engagement, від $99/міс
- **AWS SNS** — pay-as-you-go, для проектів на AWS
- **Azure Notification Hubs** — pay-as-you-go, для проектів на Azure
- **Batch** — безкоштовно до 1M push/міс, від $99/міс
- **WonderPush** — безкоштовно до 10K, від €29/міс

**Рекомендація для проекту:**
- **Старт:** Firebase Cloud Messaging (FCM) — безкоштовно, надійно, достатньо функцій для початку
- **Альтернатива:** OneSignal — якщо потрібна простіша налаштування та автоматизація нагадувань
- **Майбутнє:** Можна мігрувати на Pushwoosh або CleverTap при зростанні та потребі в розширених можливостях

### 6.2. Адмін-панель

- React + TypeScript (рекомендовано)

- Або Vue.js + TypeScript / Nuxt.js

### 6.3. Бекенд та БД

- REST API або GraphQL

- MongoDB (NoSQL база даних)

- Хостинг — AWS / DigitalOcean / Hetzner

- Автоматичні щоденні завдання (cron) для розсилки тестів о 12:00

### 6.4. Безпека

- HTTPS

- Захист від дублювання реєстрації

- Логування всіх дій в адмінці

## 7. Етапи реалізації (приблизно)

1. Прототипування UI/UX (Figma)

2. Розробка бекенду та API

3. Розробка адмін-панелі

4. Розробка мобільного додатку

5. Наповнення контентом (питання, база знань)

6. Тестування (включаючи навантажувальне на 1000+ користувачів)

7. Пілотний запуск на 1–2 ресторанах

8. Повний запуск

## 8. Формат постачання

- Исходный код на Git (GitHub/GitLab)

- Мобільні додатки в App Store та Google Play (замовник надає акаунти розробника)

- Розгорнутий сервер та налаштований сервер

- Документація API та інструкції з розгортання

- Навчання адміністраторів (2–3 години)

## 9. Структура бази даних (MongoDB)

### 9.1. Основні колекції

#### Колекція `users` (користувачі)
```javascript
{
  _id: ObjectId,
  full_name: String, // ПІБ
  city_id: ObjectId, // Reference → cities._id
  position_id: ObjectId, // Reference → positions._id
  total_score: Number, // default: 0 (бали для рейтингу)
  points_balance: Number, // default: 0 (баланс балів для магазину)
  tests_completed: Number, // default: 0
  current_streak: Number, // default: 0
  longest_streak: Number, // default: 0
  last_test_date: Date, // nullable
  avatar_id: ObjectId, // Reference → shop_products._id, nullable (куплена аватарка)
  profile_frame_id: ObjectId, // Reference → shop_products._id, nullable (куплена рамка)
  active_badges: [ObjectId], // Array of shop_products._id (активні бейджі)
  is_active: Boolean, // default: true
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- Унікальний складений: `{full_name: 1, city_id: 1, position_id: 1}` — заборона дублювання
- `city_id`, `position_id`, `is_active` — для фільтрації

#### Колекція `cities` (міста)
```javascript
{
  _id: ObjectId,
  name: String, // UNIQUE
  is_active: Boolean, // default: true
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- Унікальний: `{name: 1}`

#### Колекція `positions` (посади)
```javascript
{
  _id: ObjectId,
  name: String, // UNIQUE
  is_active: Boolean, // default: true
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- Унікальний: `{name: 1}`

#### Колекція `question_categories` (категорії питань)
```javascript
{
  _id: ObjectId,
  name: String,
  parent_id: ObjectId, // Reference → question_categories._id, nullable (для підкатегорій)
  sort_order: Number,
  is_active: Boolean, // default: true
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- `parent_id`, `is_active`, `sort_order`

#### Колекція `questions` (питання)
```javascript
{
  _id: ObjectId,
  category_id: ObjectId, // Reference → question_categories._id
  question_text: String,
  question_type: String, // 'single_choice', 'multiple_choice', 'text'
  media_type: String, // 'none', 'image', 'video' - тип медіа до питання
  image_url: String, // nullable - URL зображення (якщо media_type = 'image')
  video_url: String, // nullable - URL відео (якщо media_type = 'video')
  video_thumbnail_url: String, // nullable - прев'ю відео
  explanation: String, // nullable
  knowledge_base_article_id: ObjectId, // Reference → knowledge_base_articles._id, nullable
  answers: [ // Embedded documents (варіанти відповідей)
    {
      answer_text: String,
      is_correct: Boolean,
      sort_order: Number
    }
  ],
  is_active: Boolean, // default: true
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- `category_id`, `is_active`
- Text index: `{question_text: "text"}` — для пошуку

#### Колекція `user_tests` (проходження тестів)
```javascript
{
  _id: ObjectId,
  user_id: ObjectId, // Reference → users._id
  test_date: Date, // дата тесту (без часу)
  questions_count: Number, // default: 5
  correct_answers: Number, // default: 0
  score: Number, // default: 0
  started_at: Date, // nullable
  completed_at: Date, // nullable
  is_completed: Boolean, // default: false
  answers: [ // Embedded documents (відповіді користувача)
    {
      question_id: ObjectId, // Reference → questions._id
      selected_answer_ids: [ObjectId], // для single/multiple choice
      text_answer: String, // для text type, nullable
      is_correct: Boolean,
      answered_at: Date
    }
  ],
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- Унікальний складений: `{user_id: 1, test_date: 1}` — один тест на день
- `user_id`, `is_completed`, `test_date`

#### Колекція `knowledge_base_categories` (категорії бази знань)
```javascript
{
  _id: ObjectId,
  name: String,
  parent_id: ObjectId, // Reference → knowledge_base_categories._id, nullable
  sort_order: Number,
  is_active: Boolean, // default: true
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- `parent_id`, `is_active`, `sort_order`

#### Колекція `knowledge_base_articles` (статті бази знань)
```javascript
{
  _id: ObjectId,
  category_id: ObjectId, // Reference → knowledge_base_categories._id
  title: String,
  content: String, // Markdown або HTML
  image_url: String, // nullable
  pdf_url: String, // nullable
  is_active: Boolean, // default: true
  views_count: Number, // default: 0
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- `category_id`, `is_active`
- Text index: `{title: "text", content: "text"}` — для пошуку

#### Колекція `surveys` (опитування)
```javascript
{
  _id: ObjectId,
  title: String,
  description: String, // nullable
  survey_type: String, // 'rating', 'multiple_choice', 'text'
  is_active: Boolean, // default: true
  starts_at: Date, // nullable
  ends_at: Date, // nullable
  created_by: ObjectId, // Reference → admin_users._id
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- `is_active`, `created_by`, `starts_at`, `ends_at`

#### Колекція `survey_responses` (відповіді на опитування)
```javascript
{
  _id: ObjectId,
  survey_id: ObjectId, // Reference → surveys._id
  user_id: ObjectId, // Reference → users._id
  rating: Number, // 1-5, nullable (для rating type)
  response_text: String, // nullable
  created_at: Date
}
```
**Індекси:**
- Унікальний складений: `{survey_id: 1, user_id: 1}` — одна відповідь на опитування
- `survey_id`, `user_id`

#### Колекція `admin_users` (адміністратори)
```javascript
{
  _id: ObjectId,
  username: String, // UNIQUE
  email: String, // UNIQUE
  password_hash: String,
  role: String, // 'super_admin', 'training_admin', 'viewer'
  is_active: Boolean, // default: true
  last_login_at: Date, // nullable
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- Унікальний: `{username: 1}`, `{email: 1}`
- `role`, `is_active`

#### Колекція `push_tokens` (токени для push-повідомлень)
```javascript
{
  _id: ObjectId,
  user_id: ObjectId, // Reference → users._id
  token: String, // UNIQUE
  platform: String, // 'ios', 'android'
  is_active: Boolean, // default: true
  last_used_at: Date, // nullable
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- Унікальний: `{token: 1}`
- `user_id`, `platform`, `is_active`

#### Колекція `system_settings` (налаштування системи)
```javascript
{
  _id: ObjectId,
  key: String, // UNIQUE
  value: String, // або Number, Boolean (зберігається як String, парситься при читанні)
  description: String, // nullable
  updated_by: ObjectId, // Reference → admin_users._id, nullable
  updated_at: Date
}
```
**Індекси:**
- Унікальний: `{key: 1}`

**Приклади налаштувань:**
- `daily_test_time` — час розсилки тестів (default: "12:00")
- `test_deadline_time` — час дедлайну (default: "23:59")
- `reminder_3h_before` — нагадування за 3 години (Boolean: "true"/"false")
- `reminder_1h_before` — нагадування за 1 годину (Boolean: "true"/"false")
- `push_notification_text` — текст push-повідомлення

#### Колекція `admin_activity_logs` (лог дій адміністраторів)
```javascript
{
  _id: ObjectId,
  admin_user_id: ObjectId, // Reference → admin_users._id
  action: String, // 'create', 'update', 'delete'
  entity_type: String, // 'question', 'user', 'article'
  entity_id: ObjectId, // nullable
  details: Object, // JSON об'єкт з деталями
  ip_address: String, // nullable
  created_at: Date
}
```
**Індекси:**
- `admin_user_id`, `entity_type`, `created_at`

#### Колекція `achievements` (ачівки)
```javascript
{
  _id: ObjectId,
  name: String, // Назва ачівки
  description: String, // Опис
  icon_url: String, // URL іконки
  category: String, // 'testing', 'activity', 'accuracy', 'rating', 'special'
  condition_type: String, // 'tests_count', 'streak', 'perfect_tests', 'rating_position'
  condition_value: Number, // Значення умови (наприклад, 10 тестів, 7 днів)
  reward_points: Number, // Нагорода в балах
  is_active: Boolean, // default: true
  sort_order: Number,
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- `category`, `is_active`, `sort_order`

#### Колекція `user_achievements` (отримані ачівки користувачів)
```javascript
{
  _id: ObjectId,
  user_id: ObjectId, // Reference → users._id
  achievement_id: ObjectId, // Reference → achievements._id
  progress: Number, // Поточний прогрес (0 до condition_value)
  is_completed: Boolean, // default: false
  completed_at: Date, // nullable
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- Унікальний складений: `{user_id: 1, achievement_id: 1}`
- `user_id`, `is_completed`

#### Колекція `shop_products` (товари в магазині)
```javascript
{
  _id: ObjectId,
  name: String, // Назва товару
  description: String, // Опис
  product_type: String, // 'avatar', 'profile_frame', 'badge', 'theme', 'customization', 'gift'
  price: Number, // Ціна в балах
  image_url: String, // URL зображення товару
  preview_url: String, // URL прев'ю (для аватарок, рамок)
  is_active: Boolean, // default: true
  is_premium: Boolean, // default: false (premium товари)
  category: String, // Категорія товару
  sort_order: Number,
  created_at: Date,
  updated_at: Date
}
```
**Індекси:**
- `product_type`, `is_active`, `category`, `sort_order`

#### Колекція `user_purchases` (покупки користувачів)
```javascript
{
  _id: ObjectId,
  user_id: ObjectId, // Reference → users._id
  product_id: ObjectId, // Reference → shop_products._id
  price_paid: Number, // Ціна на момент покупки
  is_applied: Boolean, // default: false (чи застосовано товар)
  purchased_at: Date,
  applied_at: Date // nullable
}
```
**Індекси:**
- `user_id`, `product_id`, `purchased_at`

#### Колекція `points_transactions` (транзакції балів)
```javascript
{
  _id: ObjectId,
  user_id: ObjectId, // Reference → users._id
  transaction_type: String, // 'earned', 'spent', 'bonus'
  amount: Number, // Кількість балів (+ або -)
  source: String, // 'test', 'achievement', 'streak_bonus', 'purchase'
  source_id: ObjectId, // nullable (ID тесту, ачівки, покупки)
  description: String, // Опис транзакції
  balance_after: Number, // Баланс після транзакції
  created_at: Date
}
```
**Індекси:**
- `user_id`, `transaction_type`, `created_at`

### 9.2. Зв'язки між колекціями

**References (ObjectId):**
- `users.city_id` → `cities._id`
- `users.position_id` → `positions._id`
- `users.avatar_id` → `shop_products._id`
- `users.profile_frame_id` → `shop_products._id`
- `users.active_badges[]` → `shop_products._id`
- `questions.category_id` → `question_categories._id`
- `questions.knowledge_base_article_id` → `knowledge_base_articles._id`
- `user_tests.user_id` → `users._id`
- `user_tests.answers[].question_id` → `questions._id`
- `knowledge_base_articles.category_id` → `knowledge_base_categories._id`
- `surveys.created_by` → `admin_users._id`
- `survey_responses.survey_id` → `surveys._id`
- `survey_responses.user_id` → `users._id`
- `push_tokens.user_id` → `users._id`
- `system_settings.updated_by` → `admin_users._id`
- `admin_activity_logs.admin_user_id` → `admin_users._id`
- `user_achievements.user_id` → `users._id`
- `user_achievements.achievement_id` → `achievements._id`
- `user_purchases.user_id` → `users._id`
- `user_purchases.product_id` → `shop_products._id`
- `points_transactions.user_id` → `users._id`

**Self-referencing:**
- `question_categories.parent_id` → `question_categories._id`
- `knowledge_base_categories.parent_id` → `knowledge_base_categories._id`

**Embedded Documents:**
- `questions.answers[]` — варіанти відповідей вбудовані в питання
- `user_tests.answers[]` — відповіді користувача вбудовані в тест

### 9.3. Індекси для оптимізації

**Основні індекси:**
- `users`: `{full_name: 1, city_id: 1, position_id: 1}` (унікальний складений)
- `users`: `{points_balance: -1}` — для сортування за балансом
- `user_tests`: `{user_id: 1, test_date: 1}` (унікальний складений)
- `user_tests`: `{user_id: 1, is_completed: 1}` — для статистики
- `questions`: `{category_id: 1, is_active: 1}` — для вибірки питань
- `knowledge_base_articles`: Text index `{title: "text", content: "text"}` — для пошуку
- `survey_responses`: `{survey_id: 1, user_id: 1}` (унікальний складений)
- `push_tokens`: `{user_id: 1, platform: 1, is_active: 1}` — для розсилки
- `user_achievements`: `{user_id: 1, achievement_id: 1}` (унікальний складений)
- `user_achievements`: `{user_id: 1, is_completed: 1}` — для фільтрації
- `shop_products`: `{product_type: 1, is_active: 1}` — для каталогу
- `user_purchases`: `{user_id: 1, purchased_at: -1}` — для історії
- `points_transactions`: `{user_id: 1, created_at: -1}` — для історії транзакцій

### 9.4. Міграції та seeders

- Використання MongoDB migrations (mongodb-migrations / migrate-mongo / mongoose-migrate)
- Версіонування структури БД
- Seeders для початкових даних (міста, посади, адміністратори)
- Mongoose ODM або нативний MongoDB driver для Node.js

### 9.5. Особливості MongoDB для проекту

**Переваги:**
- ✅ Гнучка схема — легко додавати нові поля
- ✅ Embedded documents — відповіді в питаннях та тестах зберігаються разом
- ✅ Швидкий пошук за ObjectId
- ✅ Text search для пошуку в статтях та питаннях
- ✅ Масштабованість (sharding)

**Рекомендації:**
- Використовувати aggregation pipeline для складних запитів (рейтинги, статистика)
- Кешування часто використовуваних даних (міста, посади)
- TTL індекси для автоматичного видалення старих логів (опційно)

## 10. API специфікація

### 10.1. Загальні принципи

- **Базовий URL:** `https://api.kraina-mriy.com/api/v1`
- **Формат даних:** JSON
- **Аутентифікація:** JWT токени (Bearer Token)
- **Версіонування:** `/api/v1/`, `/api/v2/` (майбутні версії)
- **Rate limiting:** 100 запитів на хвилину для авторизованих користувачів, 20 для неавторизованих
- **Кодування:** UTF-8

### 10.2. Стандартні коди відповідей

- `200 OK` — успішний запит
- `201 Created` — ресурс створено
- `400 Bad Request` — невалідні дані
- `401 Unauthorized` — неавторизований доступ
- `403 Forbidden` — недостатньо прав
- `404 Not Found` — ресурс не знайдено
- `422 Unprocessable Entity` — помилка валідації
- `429 Too Many Requests` — перевищено ліміт запитів
- `500 Internal Server Error` — внутрішня помилка сервера

### 10.3. Формат помилок

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Помилка валідації",
    "details": {
      "field_name": ["Повідомлення про помилку"]
    }
  }
}
```

### 10.4. Аутентифікація та авторизація

#### POST /auth/register
Реєстрація нового користувача

**Request Body:**
```json
{
  "full_name": "Іванов Іван Іванович",
  "city_id": 1,
  "position_id": 2
}
```

**Response 201:**
```json
{
  "user": {
    "id": 123,
    "full_name": "Іванов Іван Іванович",
    "city": {"id": 1, "name": "Київ"},
    "position": {"id": 2, "name": "Офіціант"}
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "refresh_token_string"
}
```

#### POST /auth/login
Вхід користувача

**Request Body:**
```json
{
  "full_name": "Іванов Іван Іванович",
  "city_id": 1,
  "position_id": 2
}
```

**Response 200:** (аналогічно до register)

#### POST /auth/refresh
Оновлення токену

**Request Body:**
```json
{
  "refresh_token": "refresh_token_string"
}
```

**Response 200:**
```json
{
  "token": "new_jwt_token",
  "refresh_token": "new_refresh_token"
}
```

#### POST /auth/logout
Вихід (видалення токену)

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "message": "Успішно вийшли з системи"
}
```

### 10.5. Профіль користувача

#### GET /user/profile
Отримати профіль поточного користувача

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "id": 123,
  "full_name": "Іванов Іван Іванович",
  "city": {"id": 1, "name": "Київ"},
  "position": {"id": 2, "name": "Офіціант"},
  "total_score": 450,
  "tests_completed": 30,
  "current_streak": 5,
  "longest_streak": 12,
  "last_test_date": "2025-11-18"
}
```

#### PUT /user/profile
Оновити профіль

**Headers:** `Authorization: Bearer {token}`

**Request Body:**
```json
{
  "full_name": "Іванов Іван Іванович",
  "city_id": 1,
  "position_id": 2
}
```

### 10.6. Довідники

#### GET /cities
Отримати список міст

**Response 200:**
```json
{
  "data": [
    {"id": 1, "name": "Київ"},
    {"id": 2, "name": "Львів"},
    {"id": 3, "name": "Одеса"}
  ]
}
```

#### GET /positions
Отримати список посад

**Response 200:**
```json
{
  "data": [
    {"id": 1, "name": "Офіціант"},
    {"id": 2, "name": "Кухар"},
    {"id": 3, "name": "Банкетний менеджер"}
  ]
}
```

### 10.7. Тестування

#### GET /tests/daily
Отримати щоденний тест

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "test": {
    "id": 456,
    "test_date": "2025-11-18",
    "questions": [
      {
        "id": 1,
        "question_text": "Яка правильна температура подачі червоного вина?",
        "question_type": "single_choice",
        "media_type": "image", // 'none', 'image', 'video'
        "image_url": "https://example.com/image.jpg", // nullable, якщо media_type = 'image'
        "video_url": null, // nullable, якщо media_type = 'video'
        "video_thumbnail_url": null, // nullable, прев'ю відео
        "answers": [
          {"id": 1, "answer_text": "12-14°C", "is_correct": false},
          {"id": 2, "answer_text": "16-18°C", "is_correct": true},
          {"id": 3, "answer_text": "20-22°C", "is_correct": false},
          {"id": 4, "answer_text": "24-26°C", "is_correct": false}
        ]
      }
      // ... ще 4 питання
    ],
    "deadline": "2025-11-18T23:59:59Z"
  }
}
```

**Response 404:** Тест ще не доступний або вже завершено

#### POST /tests/{testId}/start
Почати проходження тесту

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "test_id": 456,
  "started_at": "2025-11-18T14:30:00Z"
}
```

#### POST /tests/{testId}/answer
Відправити відповідь на питання

**Headers:** `Authorization: Bearer {token}`

**Request Body:**
```json
{
  "question_id": 1,
  "answer_id": 2  // для single_choice
  // або
  // "answer_ids": [2, 3]  // для multiple_choice
  // або
  // "text_answer": "Відповідь"  // для text type
}
```

**Response 200:**
```json
{
  "is_correct": true,
  "correct_answer_id": 2,
  "explanation": "Правильно! Червоне вино подається при температурі 16-18°C",
  "knowledge_base_article_id": 10,
  "score": 1
}
```

#### POST /tests/{testId}/complete
Завершити тест

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "test_id": 456,
  "total_questions": 5,
  "correct_answers": 4,
  "score": 4,
  "total_score": 454,
  "rating_change": 5,
  "new_rating_position": 23
}
```

#### GET /tests/history
Історія пройдених тестів

**Headers:** `Authorization: Bearer {token}`

**Query Parameters:**
- `page` (default: 1)
- `per_page` (default: 20)

**Response 200:**
```json
{
  "data": [
    {
      "id": 456,
      "test_date": "2025-11-18",
      "correct_answers": 4,
      "total_questions": 5,
      "score": 4,
      "is_completed": true
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 5,
    "total": 100
  }
}
```

### 10.8. База знань

#### GET /knowledge-base/categories
Отримати категорії бази знань (дерево)

**Response 200:**
```json
{
  "data": [
    {
      "id": 1,
      "name": "Сервіс",
      "parent_id": null,
      "children": [
        {
          "id": 2,
          "name": "Сервіс вина",
          "parent_id": 1,
          "children": []
        }
      ]
    }
  ]
}
```

#### GET /knowledge-base/articles
Отримати список статей

**Query Parameters:**
- `category_id` (optional)
- `search` (optional) — пошук по тексту
- `page` (default: 1)
- `per_page` (default: 20)

**Response 200:**
```json
{
  "data": [
    {
      "id": 10,
      "title": "Правила сервірування червоного вина",
      "category_id": 2,
      "image_url": "https://example.com/article.jpg",
      "views_count": 150,
      "created_at": "2025-10-01T10:00:00Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 3,
    "total": 50
  }
}
```

#### GET /knowledge-base/articles/{id}
Отримати деталі статті

**Response 200:**
```json
{
  "id": 10,
  "title": "Правила сервірування червоного вина",
  "content": "# Заголовок\n\nТекст статті...",
  "category": {"id": 2, "name": "Сервіс вина"},
  "image_url": "https://example.com/article.jpg",
  "pdf_url": "https://example.com/article.pdf",
  "views_count": 151,
  "created_at": "2025-10-01T10:00:00Z",
  "updated_at": "2025-10-15T12:00:00Z"
}
```

### 10.9. Рейтинг та статистика

#### GET /ratings/global
Глобальний рейтинг

**Query Parameters:**
- `limit` (default: 100)
- `page` (default: 1)

**Response 200:**
```json
{
  "data": [
    {
      "position": 1,
      "user": {
        "id": 50,
        "full_name": "Петров Петро",
        "city": "Київ",
        "position": "Офіціант"
      },
      "total_score": 500,
      "tests_completed": 35,
      "current_streak": 10
    }
  ],
  "current_user_position": 23,
  "meta": {
    "current_page": 1,
    "total_pages": 5,
    "total": 500
  }
}
```

#### GET /ratings/by-city
Рейтинг за містом

**Query Parameters:**
- `city_id` (required)
- `limit` (default: 100)
- `page` (default: 1)

**Response 200:** (аналогічно до global)

#### GET /ratings/by-position
Рейтинг за посадою

**Query Parameters:**
- `position_id` (required)
- `limit` (default: 100)
- `page` (default: 1)

**Response 200:** (аналогічно до global)

#### GET /user/statistics
Особиста статистика користувача

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "total_tests": 30,
  "total_score": 450,
  "correct_answers_percentage": 85.5,
  "correct_answers_percentage_month": 90.0,
  "current_streak": 5,
  "longest_streak": 12,
  "progress_chart": [
    {"date": "2025-11-01", "score": 4, "correct": 4},
    {"date": "2025-11-02", "score": 5, "correct": 5}
    // ... останні 30 днів
  ]
}
```

### 10.10. Опитування та зворотний зв'язок

#### GET /surveys
Отримати активні опитування

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "data": [
    {
      "id": 1,
      "title": "Оцініть якість навчання",
      "description": "Допоможіть нам покращити систему",
      "survey_type": "rating",
      "is_completed": false
    }
  ]
}
```

#### POST /surveys/{id}/respond
Відправити відповідь на опитування

**Headers:** `Authorization: Bearer {token}`

**Request Body:**
```json
{
  "rating": 5,  // для rating type
  "response_text": "Дуже сподобалося!"  // для text type або коментар
}
```

**Response 200:**
```json
{
  "message": "Дякуємо за відповідь!"
}
```

#### POST /feedback/question
Запропонувати питання

**Headers:** `Authorization: Bearer {token}`

**Request Body:**
```json
{
  "question_text": "Текст питання",
  "suggested_answers": ["Відповідь 1", "Відповідь 2"],
  "category_id": 1,
  "comment": "Додатковий коментар"
}
```

#### POST /feedback/report-error
Повідомити про помилку в питанні

**Headers:** `Authorization: Bearer {token}`

**Request Body:**
```json
{
  "question_id": 123,
  "description": "Опис помилки",
  "screenshot_url": "https://example.com/screenshot.jpg"
}
```

### 10.10.1. Гейміфікація та ачівки

#### GET /achievements
Отримати ачівки користувача

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "data": [
    {
      "id": 1,
      "name": "Перший крок",
      "description": "Пройдіть перший тест",
      "icon_url": "https://example.com/icon.png",
      "category": "testing",
      "progress": 1,
      "condition_value": 1,
      "is_completed": true,
      "completed_at": "2025-11-18T10:00:00Z",
      "reward_points": 10
    },
    {
      "id": 2,
      "name": "Серія",
      "description": "Пройдіть тести 7 днів поспіль",
      "icon_url": "https://example.com/icon2.png",
      "category": "activity",
      "progress": 5,
      "condition_value": 7,
      "is_completed": false,
      "completed_at": null,
      "reward_points": 50
    }
  ]
}
```

#### GET /achievements/all
Отримати всі доступні ачівки

**Headers:** `Authorization: Bearer {token}`

**Query Parameters:**
- `category` (optional) - фільтр за категорією

**Response 200:** (аналогічно до /achievements, але включає всі ачівки)

#### GET /achievements/{id}
Деталі ачівки

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "id": 1,
  "name": "Перший крок",
  "description": "Пройдіть перший тест",
  "icon_url": "https://example.com/icon.png",
  "category": "testing",
  "condition_type": "tests_count",
  "condition_value": 1,
  "reward_points": 10,
  "progress": 1,
  "is_completed": true,
  "completed_at": "2025-11-18T10:00:00Z"
}
```

#### GET /user/achievements/progress
Прогрес до всіх ачівок

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "total_achievements": 20,
  "completed": 5,
  "in_progress": 10,
  "locked": 5,
  "achievements": [
    // список всіх ачівок з прогресом
  ]
}
```

### 10.10.2. Внутрішній магазин

#### GET /shop/products
Отримати список товарів

**Query Parameters:**
- `product_type` (optional) - фільтр за типом
- `category` (optional) - фільтр за категорією
- `page` (default: 1)
- `per_page` (default: 20)

**Response 200:**
```json
{
  "data": [
    {
      "id": 1,
      "name": "Золота рамка",
      "description": "Ексклюзивна золота рамка для профілю",
      "product_type": "profile_frame",
      "price": 100,
      "image_url": "https://example.com/frame.png",
      "preview_url": "https://example.com/frame-preview.png",
      "is_purchased": false,
      "is_applied": false
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 3,
    "total": 50
  }
}
```

#### GET /shop/products/{id}
Деталі товару

**Response 200:**
```json
{
  "id": 1,
  "name": "Золота рамка",
  "description": "Ексклюзивна золота рамка для профілю",
  "product_type": "profile_frame",
  "price": 100,
  "image_url": "https://example.com/frame.png",
  "preview_url": "https://example.com/frame-preview.png",
  "category": "frames",
  "is_purchased": false,
  "is_applied": false
}
```

#### POST /shop/purchase
Купити товар

**Headers:** `Authorization: Bearer {token}`

**Request Body:**
```json
{
  "product_id": 1
}
```

**Response 200:**
```json
{
  "purchase_id": 123,
  "product": {
    "id": 1,
    "name": "Золота рамка"
  },
  "price_paid": 100,
  "balance_after": 50,
  "message": "Товар успішно придбано!"
}
```

**Response 400:** Недостатньо балів

#### GET /shop/purchases
Історія покупок

**Headers:** `Authorization: Bearer {token}`

**Query Parameters:**
- `page` (default: 1)
- `per_page` (default: 20)

**Response 200:**
```json
{
  "data": [
    {
      "id": 123,
      "product": {
        "id": 1,
        "name": "Золота рамка",
        "product_type": "profile_frame"
      },
      "price_paid": 100,
      "is_applied": true,
      "purchased_at": "2025-11-18T12:00:00Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 2,
    "total": 15
  }
}
```

#### GET /user/balance
Баланс балів користувача

**Headers:** `Authorization: Bearer {token}`

**Response 200:**
```json
{
  "balance": 150,
  "total_earned": 500,
  "total_spent": 350,
  "recent_transactions": [
    {
      "type": "earned",
      "amount": 5,
      "source": "test",
      "description": "Правильні відповіді в тесті",
      "created_at": "2025-11-18T14:00:00Z"
    }
  ]
}
```

#### POST /user/apply-product
Застосувати куплений товар

**Headers:** `Authorization: Bearer {token}`

**Request Body:**
```json
{
  "purchase_id": 123
}
```

**Response 200:**
```json
{
  "message": "Товар успішно застосовано!"
}
```

### 10.11. Push-повідомлення

#### POST /push-tokens
Зареєструвати push-токен

**Headers:** `Authorization: Bearer {token}`

**Request Body:**
```json
{
  "token": "fcm_token_or_apns_token",
  "platform": "android"  // або "ios"
}
```

**Response 200:**
```json
{
  "message": "Токен успішно зареєстровано"
}
```

#### DELETE /push-tokens/{token}
Видалити push-токен

**Headers:** `Authorization: Bearer {token}`

### 10.12. Адмін API (тільки для адміністраторів)

#### POST /admin/auth/login
Вхід адміністратора

**Request Body:**
```json
{
  "username": "admin",
  "password": "password"
}
```

**Response 200:**
```json
{
  "admin": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "role": "super_admin"
  },
  "token": "admin_jwt_token",
  "refresh_token": "admin_refresh_token"
}
```

#### GET /admin/questions
Отримати список питань (з фільтрами)

**Headers:** `Authorization: Bearer {admin_token}`

**Query Parameters:**
- `category_id` (optional)
- `is_active` (optional)
- `search` (optional)
- `page` (default: 1)
- `per_page` (default: 20)

#### POST /admin/questions
Створити питання

**Headers:** `Authorization: Bearer {admin_token}`

**Request Body:**
```json
{
  "category_id": 1,
  "question_text": "Текст питання",
  "question_type": "single_choice",
  "image_url": "https://example.com/image.jpg",
  "explanation": "Пояснення",
  "knowledge_base_article_id": 10,
  "answers": [
    {"answer_text": "Відповідь 1", "is_correct": false},
    {"answer_text": "Відповідь 2", "is_correct": true}
  ]
}
```

#### PUT /admin/questions/{id}
Оновити питання

#### DELETE /admin/questions/{id}
Видалити питання

#### POST /admin/questions/import
Масове імпортування з Excel

**Headers:** `Authorization: Bearer {admin_token}`, `Content-Type: multipart/form-data`

**Request Body:** (form-data)
- `file`: Excel файл

#### GET /admin/users
Отримати список користувачів

**Query Parameters:**
- `city_id` (optional)
- `position_id` (optional)
- `is_active` (optional)
- `search` (optional)
- `page` (default: 1)

#### GET /admin/statistics/dashboard
Дашборд зі статистикою

**Response 200:**
```json
{
  "total_users": 1000,
  "active_users_today": 850,
  "tests_completed_today": 800,
  "completion_rate": 94.1,
  "top_cities": [
    {"city": "Київ", "users": 300, "completion_rate": 95.0}
  ],
  "top_positions": [
    {"position": "Офіціант", "users": 500, "completion_rate": 96.0}
  ]
}
```

#### GET /admin/statistics/export
Експорт статистики

**Query Parameters:**
- `format` (csv, excel)
- `date_from`
- `date_to`
- `city_id` (optional)
- `position_id` (optional)

**Response:** Файл для завантаження

#### GET /admin/achievements
Отримати список ачівок (адмін)

**Headers:** `Authorization: Bearer {admin_token}`

**Query Parameters:**
- `category` (optional)
- `is_active` (optional)
- `page` (default: 1)

#### POST /admin/achievements
Створити ачівку (адмін)

**Headers:** `Authorization: Bearer {admin_token}`

**Request Body:**
```json
{
  "name": "Перший крок",
  "description": "Пройдіть перший тест",
  "icon_url": "https://example.com/icon.png",
  "category": "testing",
  "condition_type": "tests_count",
  "condition_value": 1,
  "reward_points": 10
}
```

#### PUT /admin/achievements/{id}
Оновити ачівку (адмін)

#### DELETE /admin/achievements/{id}
Видалити ачівку (адмін)

#### GET /admin/shop/products
Отримати список товарів (адмін)

**Headers:** `Authorization: Bearer {admin_token}`

**Query Parameters:**
- `product_type` (optional)
- `is_active` (optional)
- `page` (default: 1)

#### POST /admin/shop/products
Створити товар (адмін)

**Headers:** `Authorization: Bearer {admin_token}`

**Request Body:**
```json
{
  "name": "Золота рамка",
  "description": "Ексклюзивна золота рамка",
  "product_type": "profile_frame",
  "price": 100,
  "image_url": "https://example.com/frame.png",
  "preview_url": "https://example.com/frame-preview.png",
  "category": "frames"
}
```

#### PUT /admin/shop/products/{id}
Оновити товар (адмін)

#### DELETE /admin/shop/products/{id}
Видалити товар (адмін)

## 11. Технічна архітектура

### 11.1. Загальна архітектура системи

Система складається з наступних основних компонентів:

```
┌─────────────────┐
│  Мобільний      │
│  додаток        │
│  (React Native) │
└────────┬────────┘
         │ HTTPS/REST API
         │
┌────────▼─────────────────────────┐
│  API сервер (Node.js/NestJS)     │
│  - Аутентифікація (JWT)          │
│  - Бізнес-логіка                 │
│  - Валідація даних               │
└────────┬─────────────────────────┘
         │
    ┌────┴────┬──────────────┬──────────────┐
    │         │              │              │
┌───▼───┐ ┌──▼──────┐  ┌────▼─────┐  ┌────▼──────┐
│MongoDB│ │ Firebase│  │  Файловий│  │   Cron    │
│       │ │   FCM   │  │  сервер  │  │   Jobs    │
└───────┘ └─────────┘  └──────────┘  └───────────┘
```

### 11.2. Компоненти системи

#### 11.2.1. Мобільний додаток (Frontend)
- **Технологія:** React Native (iOS + Android)
- **Основні функції:**
  - Авторизація та реєстрація
  - Проходження щоденних тестів
  - Перегляд бази знань
  - Рейтинг та статистика
  - Зворотний зв'язок
- **Offline-режим:**
  - Кешування статей бази знань
  - Кешування зображень
  - Локальне зберігання токенів
- **Push-повідомлення:**
  - Інтеграція з Firebase Cloud Messaging
  - Обробка нагадувань про тести

#### 11.2.2. API сервер (Backend)
- **Технологія:** Node.js / NestJS
- **Основні функції:**
  - REST API для мобільного додатку
  - REST API для адмін-панелі
  - Аутентифікація та авторизація (JWT)
  - Валідація та обробка даних
  - Бізнес-логіка (генерація тестів, підрахунок рейтингів)
- **Middleware:**
  - Rate limiting
  - CORS
  - Error handling
  - Request logging

#### 11.2.3. База даних
- **Технологія:** MongoDB
- **Основні колекції:**
  - users, cities, positions
  - questions, question_categories
  - user_tests, knowledge_base_articles
  - surveys, admin_users, system_settings
- **Оптимізація:**
  - Індекси для швидких запитів
  - Aggregation pipeline для складних запитів
  - Text indexes для пошуку

#### 11.2.4. Push-сервіс
- **Технологія:** Firebase Cloud Messaging (FCM)
- **Функції:**
  - Розсилка щоденних тестів
  - Нагадування про дедлайн
  - Системні сповіщення
- **Альтернатива:** OneSignal

#### 11.2.5. Файловий сервер
- **Призначення:** Зберігання статичних файлів
- **Типи файлів:**
  - Зображення до питань
  - Зображення статей бази знань
  - PDF файли
- **Варіанти реалізації:**
  - AWS S3 / DigitalOcean Spaces
  - Локальне зберігання на сервері
  - Cloudinary (для зображень)

#### 11.2.6. Cron Jobs (Завдання за розкладом)
- **Призначення:** Автоматичне виконання завдань
- **Основні завдання:**
  - Генерація щоденних тестів (00:00)
  - Розсилка push-повідомлень (12:00)
  - Нагадування за 3 та 1 годину до дедлайну
  - Оновлення рейтингів
  - Очищення старих логів
- **Реалізація:**
  - node-cron (Node.js)
  - Або окремий сервіс для cron jobs

#### 11.2.7. Адмін-панель (Web)
- **Технологія:** React + TypeScript
- **Основні функції:**
  - Управління питаннями та категоріями
  - Управління базою знань
  - Управління користувачами
  - Статистика та звіти
  - Налаштування системи
- **Аутентифікація:** JWT токени (окремий endpoint для адмінів)

### 11.3. Потоки даних

#### 11.3.1. Реєстрація користувача
```
Мобільний додаток → API → MongoDB (створення користувача)
                  → JWT токен → Мобільний додаток
```

#### 11.3.2. Проходження тесту
```
Мобільний додаток → API (GET /tests/daily) → MongoDB (вибірка питань)
                  ← API (питання з відповідями)
Мобільний додаток → API (POST /tests/{id}/answer) → MongoDB (збереження відповіді)
                  ← API (результат: правильно/неправильно)
Мобільний додаток → API (POST /tests/{id}/complete) → MongoDB (оновлення тесту, рейтингу)
                  ← API (результати тесту, зміна позиції)
```

#### 11.3.3. Розсилка push-повідомлень
```
Cron Job → API (генерація тестів) → MongoDB (створення user_tests)
        → API (отримання push-токенів) → MongoDB
        → Firebase FCM → Push-повідомлення → Мобільні пристрої
```

#### 11.3.4. Завантаження файлів
```
Адмін-панель → API (POST /admin/files/upload) → Файловий сервер
            ← API (URL файлу)
Мобільний додаток → Файловий сервер (GET) → Зображення/PDF
```

### 11.4. Інтеграції з зовнішніми сервісами

- **Firebase Cloud Messaging (FCM)** — push-повідомлення
- **Файловий хостинг** (AWS S3 / DigitalOcean Spaces) — статичні файли
- **Email сервіс** (опційно) — для адміністраторів
- **SMS сервіс** (опційно) — для критичних сповіщень

### 11.5. Масштабування та висока доступність

#### 11.5.1. Горизонтальне масштабування
- **API сервер:** Кілька інстансів за load balancer
- **MongoDB:** Replica Set для високої доступності
- **Файловий сервер:** CDN для швидкої доставки

#### 11.5.2. Вертикальне масштабування
- Збільшення ресурсів сервера (CPU, RAM)
- Оптимізація запитів до БД
- Кешування часто використовуваних даних (Redis)

#### 11.5.3. Кешування
- **Redis** (опційно) для кешування:
  - Списки міст та посад
  - Рейтинги (оновлення раз на хвилину)
  - Налаштування системи
- **CDN** для статичних файлів

### 11.6. Backup та disaster recovery

#### 11.6.1. Backup стратегія
- **MongoDB:** Автоматичні щоденні backup
- **Файли:** Реплікація на інший сервер або S3
- **Код:** Git репозиторій (GitHub/GitLab)

#### 11.6.2. Disaster recovery
- Зберігання backup на окремому сервері/хмарі
- План відновлення (RTO < 4 години)
- Тестування відновлення (раз на квартал)

### 11.7. Моніторинг та логування

- **Логування:** Winston / Pino для Node.js
- **Моніторинг помилок:** Sentry
- **Метрики:** Prometheus + Grafana (опційно)
- **Uptime моніторинг:** UptimeRobot / Pingdom

### 11.8. Безпека

- **HTTPS:** Обов'язково для всіх з'єднань
- **JWT токени:** З коротким терміном дії + refresh tokens
- **Rate limiting:** Захист від DDoS
- **Валідація:** Всі вхідні дані перевіряються
- **Шифрування:** Паролі хешуються (bcrypt)

---


